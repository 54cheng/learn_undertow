## Servlet容器和规范

> undertow是web服务器，也是个servlet容器，这一节介绍什么是servlet容器和servlet规范。

### Servlet规范
Servlet，广义的意思是用Java编写的服务器端程序。狭义的servlet就是一个Java接口，servlet接口定义的是一套处理网络请求的规范，servlet接口定义了下面5个方法：
```
public interface Servlet {
    void init(ServletConfig var1) throws ServletException;

    ServletConfig getServletConfig();

    void service(ServletRequest var1, ServletResponse var2) throws ServletException, IOException;

    String getServletInfo();

    void destroy();
}
```
- 2个生命周期方法，init()和destroy()
- 1个处理请求的方法，service()
- 2个配置方法，getServletConfig()和getServletInfo()

Servlet是一个规范，但是实现了servlet的类，是不能处理请求的，我们不会在servlet中写监听8080端口的代码，servlet不会直接和客户端打交道，那请求怎么来到servlet呢？答案就是servlet容器，比较常用的有tomcat和jetty，以及我们研究的undertow。

> servlet API现在的版本是4.0，在JavaEE8发布的，主要特性是HTTP/2，另外主流的版本是3.1，主要特性是非阻塞IO和HTTP协议更新机制

### Servlet容器
Servlet容器才是与客户端直接打交道的家伙，它监听了端口，请求过来后，根据url等信息，确定要将请求交给哪个servlet去处理，然后调用那个servlet的service方法，service方法返回一个response对象，servlet容器再把这个response返回给客户端。

Servlet容器会实例化和调用servlet，我们一般以Web应用程序的方式部署servlet，根据servlet规范，web应用有一定的目录结构，在这个目录下分别放置了servlet的类文件、配置文件以静态资源，servlet容器通过读取配置文件，就能找到并加载servlet了，web应用的目录结构如下：
- WEB-INF/web.xml，配置文件，用来配置servlet信息等
- WEB-INF/lib/，存放web应用所需的JAR包
- WEB-INF/classes/，存放我们的应用类
- META-INF/，存放工程的一些信息

Web应用部署好后，servlet容器在启动时会加载web应用，并为每个web应用创建唯一的ServletContext对象。一个web应用可能有多个servlet，这些servlet可以通过全局的ServletContext来共享数据，这些数据包括web应用的初始化参数、web应用目录下的文件资源等。

下面我们编写一个简单的helloServlet程序，并部署到servlet容器和运行。

### Servlet实战
1. 下载Tomcat

> 使用tomcat因为undertow没有独立的应用，后面在《2.3-servlet4.0》再介绍undertow使用servlet编程。

[官网下载](https://tomcat.apache.org/download-90.cgi)tomcat最新版本9.0.20，解压后文件结构如下：
- bin：存放Windows或Linux平台上的Tomcat脚本文件
- conf：存放Tomcat配置文件，其中比较重要的是server.xml
- lib：存放Tomcat以及所有Web应用都可以访问的JAR文件
- log：存放Tomcat日志文件
- work：存放JSP编译后产生的class文件
- webapps：Tomcat的web应用目录

2. 编写 hello-servlet web应用

**HelloServlet.java**
```
public class HelloServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        System.out.println("HelloServlet doGet() running...");
        PrintWriter pw = resp.getWriter();
        resp.setContentType("text/html;charset=utf-8");
        pw.println("<strong>Hello Servlet</strong>");
    }

}
```

编译：
```
javac -cp ./javax.servlet-api-4.0.0.jar HelloServlet.java
```

3. 部署到tomcat和测试
在tomcat的webapps创建HelloServlet目录，目录结构如下：
- HelloServlet/WEB-INF/classes，把编译好的HelloServlet.class拷贝过去
- HelloServlet/WEB-INF/web.xml，具体内容如下：
```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
  http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
  version="4.0"
  metadata-complete="true">

    <description>Hello Servlet</description>
    <display-name>Hello Servlet</display-name>
    <request-character-encoding>UTF-8</request-character-encoding>

    <servlet>
      <servlet-name>helloServlet</servlet-name>
      <servlet-class>HelloServlet</servlet-class>
    </servlet>

    <servlet-mapping>
      <servlet-name>helloServlet</servlet-name>
      <url-pattern>/helloservlet</url-pattern>
    </servlet-mapping>
</web-app>
```

在tomcat的bin目录下运行startup.sh，windows操作系统运行startup.bat。打开浏览器访问URL：http://localhost:8080/HelloServlet/helloservlet

显示粗体的Hello Servlet：
```
Hello Servlet
```

### 资料
- [servlet](https://zh.wikipedia.org/wiki/Java_Servlet)
- [tomcat](http://tomcat.apache.org/)
- [jetty](https://www.eclipse.org/jetty/)